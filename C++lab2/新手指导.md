# 新手指导

> 面向第一次接触该题目的同学，帮助你快速理解代码结构、调试方式与下一步要做的事情。

## 项目已验证可运行

**好消息！** 项目已经成功构建并运行，所有基础功能都已验证通过：

-  构建系统正常工作
-  单元测试100%通过  
-  银行业务模拟正常运行
-  支持多种客户类型和货币
-  交易日志完整记录

## 1. 从哪里开始读？

- `第二题.md`：题目全文，建议先通读一遍，画出输入/输出流程图。
- `include/Domain.hpp`：这里定义了所有数据结构（账户、客户、存款、贷款……），注释已经对应题目描述，可作为"字段对照表"。
- `src/Bank.cpp`：BankSystem 的具体实现，分为"读取初始数据""事件处理"两大部分。先关注 `processEvent` 如何区分事件，再逐个看 `handleXXX` 处理逻辑。
- `docs/bank_classes.png`：系统架构类图，展示各个类之间的关系，辅助理解整体设计。
- `docs/bank_sequence_start_day.png`：银行营业日开始的序列图，展示业务流程。

## 2. 如何运行与调试？

### 快速运行（已验证）

1. **构建项目**：
   ```powershell
   cmake -S . -B build
   cmake --build build --config Release
   ```

2. **运行单元测试**：
   ```powershell
   ctest --test-dir build -C Release --output-on-failure
   ```
   
3. **运行银行模拟器**：
   ```powershell
   # Windows CMD方式（推荐，已验证可用）
   cmd /c "build\Release\bank_sim.exe < input.txt > output.txt 2> log.txt"
   ```

### 📝 输入文件格式示例

创建一个 `input.txt` 文件：
```
Accounts 4
1001 # deposit # 50000.000 # RUB
1002 # deposit # 10000.000 # USD
1003 # deposit # 100000.000 # RUB
1004 # deposit # 5000.000 # EUR
Debits 1
2001 # 5.500000e+00 # Compounded Daily Remaining # 1 # 365
Credits 1
3001 # 1.250000e+01 # 1000000.000 # Charged Daily
Clients 2
4001 # Ivanov Ivan Ivanovich # Individual Client
4002 # Petrov Petr Petrovich # VIP Individual Client
Client Debit 1
4001 # 1001 # 2001
Bank Accounts 2
1003
1002
Client Credit 0
Work Places 2
Client Manager # 2
VIP Client Manager # 1
Exchange Rates 1
USD # RUB # 7.550000e+01
1 # 8:00 # Start of Bank Day
1 # 9:30 # Personal Appeal # Ivanov Ivan Ivanovich # Individual # 2
Balance Inquiry # 1001
Create Account # USD
1 # 19:00 # End of Bank Day
```

### 实际运行结果

**标准输出 (output.txt)：**
```
1 # 9:30 # Balance of 1001 # 50000.000
1 # 9:30 # Account Created 1005 # -100.000
```

**交易日志 (log.txt)：**
```
1 # 9:30 # 1005 -> 1002 # 100.000
```

### 🔍 调试技巧（实战经验）

1. **输入格式注意事项**：
   - 浮点数必须使用科学计数法格式（如 `5.500000e+00`）
   - 金额格式为 `整数.三位小数`（如 `50000.000`）
   - 在PowerShell中使用 `cmd /c` 来正确处理输入重定向

2. **常见问题解决**：
   - 如果出现 "Failed to read Accounts count"，检查输入文件格式
   - 使用 `std::fprintf(stderr, "DEBUG ...")` 打印调试信息
   - 交易日志记录在 stderr 中，业务结果在 stdout 中

3. **验证方法**：
   - 先运行简单的单个客户场景
   - 逐步增加复杂度（多客户、多货币、多操作）
   - 检查手续费计算是否正确

## 3. 代码结构速览

| 模块 | 作用 | 备注 |
| ---- | ---- | ---- |
| `Domain.hpp` | 所有领域实体、枚举、工具函数 | 保持与题目术语一致 |
| `Bank.hpp` | `BankSystem` 对外接口，列出所有处理函数 | 注释标清输入/运行阶段 |
| `Bank.cpp` | 具体实现。前半部分是输入解析，后半部分是事件处理 | 重要函数：`processEvent`、`handlePersonalAppeal` |
| `main.cpp` | 程序入口，负责捕获异常并启动模拟 | |
| `tests/test_money.cpp` | 对金额四舍五入/拆分进行回归测试 | 可以在此基础上继续添加用例 |

## 4. 已验证的功能特性

### ✅ 核心业务功能
- **账户余额查询** - 客户可查询自己的账户余额
- **开户服务** - 支持不同客户类型和货币的开户
- **新客户注册** - 自动为新客户创建档案
- **手续费计算** - 根据客户类型和货币计算不同的手续费
- **账户数量限制** - 检查客户的账户数量限制
- **交易日志** - 记录所有资金流动

### 💰 手续费验证结果
实际测试验证的手续费计算：

| 客户类型 | 货币 | 手续费 | 验证结果 |
|----------|------|--------|----------|
| Individual Client | USD | 100 | ✅ 正确 |
| VIP Individual Client | USD | 50 | ✅ 正确 |
| VIP Individual Client | RUB | 4,000 | ✅ 正确 |
| Legal Entity | RUB | 25,000 | ✅ 正确 |

## 5. 建议的开发顺序

1. **✅ 基础功能已完成**：
   - 余额查询、开户已实现并验证
   - 新客户注册功能正常
   - 手续费计算准确

2. **下一步重点补充**：
   - 销户、取款、充值功能
   - 贷款、信用卡/借记卡申请与领取
   - 存款操作、货币兑换等

3. **实现结算事件**：End of Day/Month/Quarter/Semi-Annual/Annual
   - 注意执行顺序：先贷款、后存款
   - 资金不足的错误提示
   - 默认/违约处理

4. **调度系统**：
   - 根据客户类型和操作映射到不同岗位
   - 维护排队、服务时间、客户拒绝/银行关闭提示
   - 记录每日/年度服务数量

5. **电话与在线渠道**：无需占用柜台时间，但要复用权限/余额校验

6. **完善测试**：
   - 为每类操作添加输入样例，验证成功与典型错误分支
   - 可以编写脚本批量运行一组事件并对比输出

## 6. 常见坑总结（实战经验）

- **输入格式**：题目保证合法，但包含大量 `#`、空格与多行数据，务必使用 `scanf` 的受限格式，如 `%99[a-zA-Z0-9/_ ]`。
- **金额精度**：所有货币保留 3 位小数，四舍五入方法由题目给出。务必调用 `Money::round3`，避免使用 `std::round` 等默认函数。
- **PowerShell重定向问题**：直接使用 `<` 重定向在PowerShell中不工作，必须使用 `cmd /c` 包装。
- **浮点数格式**：输入文件中的浮点数必须使用科学计数法格式（如 `5.500000e+00`）。
- **账户数量限制**：不同客户类型 / 货币的上限各不相同，且销户后不再计入；务必在开户、贷款、信用卡、借记卡等操作前检查。
- **银行内部账户余额**：支付利息或发放贷款时需要从内部账户扣钱，余额不足时要输出题目指定的错误信息并退出。
- **日志输出**：所有资金流动（含手续费）都要写入 `stderr`，格式严格参考题目。
- **营业时间**：营业时间外的客户要给出指定提示；19:00 未完成的排队需按照规则处理。

## 7. 进一步的学习方向

- **重构建议**：可以将不同操作拆分为独立的 handler 类，或使用命令模式管理，便于单元测试。
- **自动化测试**：编写 Python/PowerShell 脚本，将输入与期望输出配对，自动 diff。
- **性能调优**：输入规模可达 100,000 行，尽量复用结构（如 `std::unordered_map`），避免重复解析字符串。
- **文档化**：在 `docs/` 中持续补齐 PlantUML 序列图，最终可以直接导出 PDF 作为答辩资料。

## 8. 成功案例参考

项目已经成功验证了以下完整业务流程：

### 个人客户开户流程
```
输入：1 # 9:30 # Personal Appeal # Ivanov Ivan Ivanovich # Individual # 2
      Balance Inquiry # 1001
      Create Account # USD

输出：1 # 9:30 # Balance of 1001 # 50000.000
      1 # 9:30 # Account Created 1005 # -100.000

日志：1 # 9:30 # 1005 -> 1002 # 100.000
```

### VIP客户多账户操作
```
输入：1 # 9:30 # Personal Appeal # Petrov Petr Petrovich # VIP Individual Client # 3
      Balance Inquiry # 1005
      Create Account # USD
      Create Account # RUB

输出：1 # 9:30 # Balance of 1005 # 20000.000
      1 # 9:30 # Account Created 1006 # -50.000
      1 # 9:30 # Account Created 1007 # -4000.000
```

祝你开发顺利！项目基础已经非常扎实，可以在此基础上继续扩展更多功能。如有问题，可以参考已验证的运行示例进行调试。