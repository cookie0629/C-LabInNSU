# é“¶è¡Œåˆ†è¡Œæ¨¡æ‹Ÿå™¨ä¸­çš„è®¾è®¡æ¨¡å¼åˆ†æ

## ğŸ¯ é¡¹ç›®ä¸­ä½¿ç”¨çš„è®¾è®¡æ¨¡å¼åŠå¯¹åº”ä»£ç 

### 1. **ç­–ç•¥æ¨¡å¼ (Strategy Pattern)**

#### ğŸ“ åº”ç”¨åœºæ™¯ï¼šæ‰‹ç»­è´¹è®¡ç®—ç­–ç•¥

**ä»£ç ä½ç½®ï¼š** `src/Bank.cpp` ç¬¬700-750è¡Œ

```cpp
static double accountOpeningFee(domain::CustomerKind kind, domain::Currency currency) {
    struct Rule {
        domain::CustomerKind kind;
        domain::Currency currency;
        double fee;
    };

    static const Rule rules[] = {
        {domain::CustomerKind::Individual, domain::Currency::RUB, 10000.0},
        {domain::CustomerKind::VipIndividual, domain::Currency::RUB, 4000.0},
        {domain::CustomerKind::Legal, domain::Currency::RUB, 25000.0},
        {domain::CustomerKind::VipLegal, domain::Currency::RUB, 15000.0},
        {domain::CustomerKind::Individual, domain::Currency::USD, 100.0},
        {domain::CustomerKind::VipIndividual, domain::Currency::USD, 50.0},
        // ... æ›´å¤šè§„åˆ™
    };

    for (const auto& rule : rules) {
        if (rule.kind == kind && rule.currency == currency) 
            return rule.fee;
    }
    return 0.0;
}
```

**è®¾è®¡æ¨¡å¼ç‰¹ç‚¹ï¼š**
- **ç­–ç•¥å°è£…**ï¼šæ¯ç§å®¢æˆ·ç±»å‹+è´§å¸ç»„åˆå¯¹åº”ä¸€ä¸ªæ‰‹ç»­è´¹ç­–ç•¥
- **è¿è¡Œæ—¶é€‰æ‹©**ï¼šæ ¹æ®è¾“å…¥å‚æ•°åŠ¨æ€é€‰æ‹©åˆé€‚çš„ç­–ç•¥
- **æ˜“äºæ‰©å±•**ï¼šæ–°å¢å®¢æˆ·ç±»å‹æˆ–è´§å¸åªéœ€æ·»åŠ è§„åˆ™è¡¨é¡¹

#### ğŸ“ åº”ç”¨åœºæ™¯ï¼šè´¦æˆ·æ•°é‡é™åˆ¶ç­–ç•¥

**ä»£ç ä½ç½®ï¼š** `src/Bank.cpp` ç¬¬750-780è¡Œ

```cpp
static unsigned int accountLimit(domain::CustomerKind kind, domain::Currency currency) {
    static const LimitRule rules[] = {
        {domain::CustomerKind::Individual, domain::Currency::RUB, 3},
        {domain::CustomerKind::VipIndividual, domain::Currency::RUB, 5},
        {domain::CustomerKind::Legal, domain::Currency::RUB, 10},
        {domain::CustomerKind::VipLegal, domain::Currency::RUB, 25},
        // ... æ›´å¤šé™åˆ¶è§„åˆ™
    };
    
    for (const auto& rule : rules) {
        if (rule.kind == kind && rule.currency == currency) 
            return rule.limit;
    }
    return 0;
}
```

#### ğŸ“ åº”ç”¨åœºæ™¯ï¼šæ“ä½œæƒé™ç­–ç•¥

**ä»£ç ä½ç½®ï¼š** `src/Bank.cpp` ç¬¬25-40è¡Œ

```cpp
bool isOperationAllowed(domain::CustomerKind kind, std::string_view operation) {
    static const std::unordered_map<std::string_view, std::array<bool, 4>> table = {
        {"Balance Inquiry", {true, true, true, true}},
        {"Create Account", {true, true, true, true}},
        {"Currency Exchange", {true, true, false, true}}, // Legal Entityä¸èƒ½å…‘æ¢
    };
    
    const auto idx = kindIndex(kind);
    auto it = table.find(operation);
    return it->second[idx];  // æ ¹æ®å®¢æˆ·ç±»å‹ç´¢å¼•è¿”å›æƒé™
}
```

---

### 2. **å‘½ä»¤æ¨¡å¼ (Command Pattern)**

#### ğŸ“ åº”ç”¨åœºæ™¯ï¼šäº‹ä»¶å¤„ç†ç³»ç»Ÿ

**ä»£ç ä½ç½®ï¼š** `src/Bank.cpp` ç¬¬600-650è¡Œ

```cpp
void BankSystem::processEvent(const char* buffer) {
    unsigned long long day{}, hour{}, minute{};
    char payload[kLineBuffer]{};
    
    // è§£æäº‹ä»¶å¤´éƒ¨
    std::sscanf(buffer, "%llu # %llu:%llu # %255[^\n]\n", 
                &day, &hour, &minute, payload);

    // å‘½ä»¤åˆ†å‘ - æ ¹æ®äº‹ä»¶ç±»å‹è°ƒç”¨å¯¹åº”çš„å¤„ç†å™¨
    if (std::strncmp(payload, "Start of Bank Day", 17) == 0) {
        handleStartOfDay(day, hour, minute);        // å‘½ä»¤1
    } else if (std::strncmp(payload, "End of Bank Day", 15) == 0) {
        handleEndOfDay(day, hour, minute);          // å‘½ä»¤2
    } else if (std::strncmp(payload, "Personal Appeal", 15) == 0) {
        handlePersonalAppeal(day, hour, minute, payload);  // å‘½ä»¤3
    }
}
```

**è®¾è®¡æ¨¡å¼ç‰¹ç‚¹ï¼š**
- **å‘½ä»¤å°è£…**ï¼šæ¯ä¸ªäº‹ä»¶ç±»å‹å¯¹åº”ä¸€ä¸ªå¤„ç†å‘½ä»¤
- **è§£è€¦è°ƒç”¨è€…å’Œæ¥æ”¶è€…**ï¼š`processEvent`ä¸éœ€è¦çŸ¥é“å…·ä½“å¤„ç†é€»è¾‘
- **ç»Ÿä¸€æ¥å£**ï¼šæ‰€æœ‰å‘½ä»¤éƒ½æœ‰ç›¸åŒçš„æ—¶é—´å‚æ•°æ ¼å¼

#### ğŸ“ åº”ç”¨åœºæ™¯ï¼šå®¢æˆ·æ“ä½œå¤„ç†

**ä»£ç ä½ç½®ï¼š** `src/Bank.cpp` ç¬¬650-700è¡Œ

```cpp
// Personal Appealä¸­çš„æ“ä½œå‘½ä»¤å¤„ç†
for (const auto& operation : operations) {
    if (operation.rfind("Balance Inquiry", 0) == 0) {
        // å‘½ä»¤ï¼šä½™é¢æŸ¥è¯¢
        handleBalanceInquiry(*client, accountId, day, hour, minute);
    } else if (operation.rfind("Create Account", 0) == 0) {
        // å‘½ä»¤ï¼šå¼€æˆ·
        handleCreateAccount(*client, kind, currency, day, hour, minute);
    } else {
        // æœªçŸ¥å‘½ä»¤çš„é»˜è®¤å¤„ç†
        std::printf("Service not available\n");
    }
}
```

---

### 3. **æ¨¡æ¿æ–¹æ³•æ¨¡å¼ (Template Method Pattern)**

#### ğŸ“ åº”ç”¨åœºæ™¯ï¼šæ•°æ®è¯»å–æ¨¡æ¿

**ä»£ç ä½ç½®ï¼š** `src/Bank.cpp` ç¬¬80-100è¡Œ

```cpp
template <typename Fn>
void repeatRead(unsigned long long count, Fn &&fn) {
    for (unsigned long long i = 0; i < count; ++i) {
        if (!fn(i)) {  // è°ƒç”¨å…·ä½“çš„è¯»å–é€»è¾‘
            std::fprintf(stderr, "Failed to read entry %llu\n", i);
            std::exit(EXIT_FAILURE);
        }
    }
}
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š** `src/Bank.cpp` ç¬¬120-140è¡Œ

```cpp
void BankSystem::readAccounts() {
    unsigned long long count{};
    std::scanf("Accounts %llu\n", &count);
    
    // æ¨¡æ¿æ–¹æ³•ï¼šç»Ÿä¸€çš„å¾ªç¯æ¡†æ¶ + å…·ä½“çš„è§£æé€»è¾‘
    repeatRead(count, [this](unsigned long long) {
        // å…·ä½“çš„è´¦æˆ·è§£æé€»è¾‘
        unsigned long long id{};
        char type[domain::kMaxString]{};
        // ... è§£æä»£ç 
        accounts_.emplace(id, std::move(account));
        return true;
    });
}
```

**è®¾è®¡æ¨¡å¼ç‰¹ç‚¹ï¼š**
- **ç®—æ³•æ¡†æ¶å›ºå®š**ï¼šå¾ªç¯è¯»å–+é”™è¯¯å¤„ç†çš„æ¡†æ¶ä¸å˜
- **å…·ä½“æ­¥éª¤å¯å˜**ï¼šæ¯ç§æ•°æ®ç±»å‹æœ‰ä¸åŒçš„è§£æé€»è¾‘
- **ä»£ç å¤ç”¨**ï¼šé¿å…åœ¨æ¯ä¸ª`readXXX`å‡½æ•°ä¸­é‡å¤å¾ªç¯ä»£ç 

---

### 4. **å·¥å‚æ–¹æ³•æ¨¡å¼ (Factory Method Pattern)**

#### ğŸ“ åº”ç”¨åœºæ™¯ï¼šå®¢æˆ·åˆ›å»ºå·¥å‚

**ä»£ç ä½ç½®ï¼š** `src/Bank.cpp` ç¬¬500-530è¡Œ

```cpp
domain::Client* BankSystem::ensureClientByName(const std::string& name, 
                                               domain::CustomerKind fallbackType) {
    // æŸ¥æ‰¾ç°æœ‰å®¢æˆ·
    if (auto existing = findClientByName(name)) {
        return existing;
    }
    
    // å·¥å‚æ–¹æ³•ï¼šåˆ›å»ºæ–°å®¢æˆ·
    domain::Client client{};
    client.id = nextClientId_++;           // è‡ªåŠ¨ç”ŸæˆID
    client.name = name;
    client.type = domain::toString(fallbackType);  // ç±»å‹è½¬æ¢
    
    // æ³¨å†Œåˆ°ç³»ç»Ÿä¸­
    auto [it, inserted] = clients_.emplace(client.id, std::move(client));
    clientNameToId_[name] = it->second.id;  // å»ºç«‹ç´¢å¼•
    accountCountByCurrency_[it->second.id]; // åˆå§‹åŒ–è®¡æ•°
    
    return &it->second;
}
```

#### ğŸ“ åº”ç”¨åœºæ™¯ï¼šè´¦æˆ·åˆ›å»ºå·¥å‚

**ä»£ç ä½ç½®ï¼š** `src/Bank.cpp` ç¬¬780-820è¡Œ

```cpp
void BankSystem::handleCreateAccount(...) {
    // å·¥å‚æ–¹æ³•ï¼šåˆ›å»ºæ–°è´¦æˆ·
    unsigned long long accountId = nextAccountId_++;
    domain::Account newAccount{};
    newAccount.id = accountId;
    newAccount.type = "deposit";           // ç»Ÿä¸€ç±»å‹
    newAccount.balance = -fee;             // åˆå§‹ä½™é¢ï¼ˆæ‰£é™¤æ‰‹ç»­è´¹ï¼‰
    newAccount.currency = currencyStr;
    newAccount.active = true;              // é»˜è®¤æ¿€æ´»
    
    // æ³¨å†Œåˆ°ç³»ç»Ÿ
    accounts_.emplace(accountId, newAccount);
    
    // å»ºç«‹å…³è”å…³ç³»
    domain::ClientAccount rel{};
    rel.clientId = client.id;
    rel.accountId = accountId;
    clientAccounts_[client.id].push_back(rel);
}
```

---

### 5. **è§‚å¯Ÿè€…æ¨¡å¼ (Observer Pattern)**

#### ğŸ“ åº”ç”¨åœºæ™¯ï¼šäº¤æ˜“æ—¥å¿—è®°å½•

**ä»£ç ä½ç½®ï¼š** `src/Bank.cpp` ç¬¬820è¡Œï¼ˆæ–‡ä»¶æœ«å°¾ï¼‰

```cpp
void BankSystem::logAccountTransfer(unsigned long long day,
                                    unsigned long long hour,
                                    unsigned long long minute,
                                    unsigned long long fromAccount,
                                    unsigned long long toAccount,
                                    double amount) const {
    // è§‚å¯Ÿè€…ï¼šè‡ªåŠ¨è®°å½•æ‰€æœ‰èµ„é‡‘æµåŠ¨
    auto fmt = domain::formatMoney(amount);
    std::fprintf(stderr, "%llu # %llu:%llu # %llu -> %llu # %s%llu.%03llu\n",
                 day, hour, minute, fromAccount, toAccount,
                 fmt.negative ? "-" : "", fmt.major, fmt.minor);
}
```

**è§¦å‘åœºæ™¯ï¼š** åœ¨`handleCreateAccount`ä¸­

```cpp
// ä¸»ä¸šåŠ¡é€»è¾‘ï¼šè½¬è´¦æ‰‹ç»­è´¹
bankAccount->balance += fee;

// è§‚å¯Ÿè€…è‡ªåŠ¨è§¦å‘ï¼šè®°å½•äº¤æ˜“æ—¥å¿—
logAccountTransfer(day, hour, minute, accountId, bankAccountIt->second, fee);
```

---

### 6. **å•ä¾‹æ¨¡å¼ (Singleton Pattern)**

#### ğŸ“ åº”ç”¨åœºæ™¯ï¼šå…¨å±€é…ç½®è¡¨

**ä»£ç ä½ç½®ï¼š** `src/Bank.cpp` ç¬¬25-40è¡Œ

```cpp
bool isOperationAllowed(domain::CustomerKind kind, std::string_view operation) {
    // å•ä¾‹ï¼šå…¨å±€å”¯ä¸€çš„æƒé™é…ç½®è¡¨
    static const std::unordered_map<std::string_view, std::array<bool, 4>> table = {
        {"Balance Inquiry", {true, true, true, true}},
        {"Create Account", {true, true, true, true}},
        {"Currency Exchange", {true, true, false, true}},
    };
    // ... ä½¿ç”¨é€»è¾‘
}
```

**è®¾è®¡æ¨¡å¼ç‰¹ç‚¹ï¼š**
- **å…¨å±€å”¯ä¸€**ï¼šä½¿ç”¨`static`ç¡®ä¿é…ç½®è¡¨åªæœ‰ä¸€ä¸ªå®ä¾‹
- **å»¶è¿Ÿåˆå§‹åŒ–**ï¼šç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶æ‰åˆ›å»º
- **çº¿ç¨‹å®‰å…¨**ï¼šC++11ä¿è¯é™æ€å±€éƒ¨å˜é‡çš„çº¿ç¨‹å®‰å…¨åˆå§‹åŒ–

---

### 7. **é€‚é…å™¨æ¨¡å¼ (Adapter Pattern)**

#### ğŸ“ åº”ç”¨åœºæ™¯ï¼šæšä¸¾åˆ°ç´¢å¼•çš„é€‚é…

**ä»£ç ä½ç½®ï¼š** `src/Bank.cpp` ç¬¬15-25è¡Œ

```cpp
int kindIndex(domain::CustomerKind kind) {
    // é€‚é…å™¨ï¼šå°†æšä¸¾ç±»å‹é€‚é…ä¸ºæ•°ç»„ç´¢å¼•
    switch (kind) {
        case domain::CustomerKind::Individual: return 0;
        case domain::CustomerKind::VipIndividual: return 1;
        case domain::CustomerKind::Legal: return 2;
        case domain::CustomerKind::VipLegal: return 3;
        default: return -1;
    }
}

int currencyIndex(domain::Currency currency) {
    // é€‚é…å™¨ï¼šå°†è´§å¸æšä¸¾é€‚é…ä¸ºæ•°ç»„ç´¢å¼•
    switch (currency) {
        case domain::Currency::RUB: return 0;
        case domain::Currency::YUAN: return 1;
        case domain::Currency::USD: return 2;
        case domain::Currency::EUR: return 3;
        default: return -1;
    }
}
```

**ä½¿ç”¨åœºæ™¯ï¼š**
```cpp
// åœ¨æƒé™æ£€æŸ¥ä¸­ä½¿ç”¨é€‚é…å™¨
const auto idx = kindIndex(kind);
return it->second[idx];  // ç›´æ¥ç”¨ç´¢å¼•è®¿é—®æ•°ç»„

// åœ¨è´¦æˆ·è®¡æ•°ä¸­ä½¿ç”¨é€‚é…å™¨
const auto idx = currencyIndex(currency);
accountCountByCurrency_[clientId][idx]++;
```

---

## ğŸ—ï¸ è®¾è®¡æ¨¡å¼çš„ååŒå·¥ä½œ

### å®Œæ•´çš„ä¸šåŠ¡æµç¨‹ä¸­çš„æ¨¡å¼åä½œ

ä»¥"å®¢æˆ·å¼€æˆ·"ä¸ºä¾‹ï¼Œå±•ç¤ºå¤šä¸ªè®¾è®¡æ¨¡å¼çš„ååŒå·¥ä½œï¼š

```cpp
// 1. å‘½ä»¤æ¨¡å¼ï¼šäº‹ä»¶åˆ†å‘
processEvent("Personal Appeal # Ivanov # Individual # 1")
    â†“
handlePersonalAppeal(...)
    â†“
// 2. å·¥å‚æ–¹æ³•ï¼šåˆ›å»ºå®¢æˆ·ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
ensureClientByName("Ivanov", CustomerKind::Individual)
    â†“
// 3. å‘½ä»¤æ¨¡å¼ï¼šæ“ä½œåˆ†å‘
handleCreateAccount(...)
    â†“
// 4. ç­–ç•¥æ¨¡å¼ï¼šè®¡ç®—æ‰‹ç»­è´¹
accountOpeningFee(Individual, USD) â†’ 100.0
    â†“
// 5. é€‚é…å™¨æ¨¡å¼ï¼šè´§å¸ç´¢å¼•è½¬æ¢
currencyIndex(USD) â†’ 2
    â†“
// 6. å·¥å‚æ–¹æ³•ï¼šåˆ›å»ºè´¦æˆ·
Account newAccount{id, "deposit", -100.0, "USD"}
    â†“
// 7. è§‚å¯Ÿè€…æ¨¡å¼ï¼šè®°å½•äº¤æ˜“æ—¥å¿—
logAccountTransfer(1005 -> 1002 # 100.000)
```

## ğŸ¯ è®¾è®¡æ¨¡å¼çš„ä¼˜åŠ¿

1. **ç­–ç•¥æ¨¡å¼**ï¼šä¸šåŠ¡è§„åˆ™é…ç½®åŒ–ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•
2. **å‘½ä»¤æ¨¡å¼**ï¼šäº‹ä»¶å¤„ç†è§£è€¦ï¼Œæ”¯æŒæ–°äº‹ä»¶ç±»å‹
3. **æ¨¡æ¿æ–¹æ³•**ï¼šä»£ç å¤ç”¨ï¼Œç»Ÿä¸€çš„é”™è¯¯å¤„ç†
4. **å·¥å‚æ–¹æ³•**ï¼šå¯¹è±¡åˆ›å»ºæ ‡å‡†åŒ–ï¼Œè‡ªåŠ¨IDç”Ÿæˆ
5. **è§‚å¯Ÿè€…æ¨¡å¼**ï¼šè‡ªåŠ¨æ—¥å¿—è®°å½•ï¼Œæ— éœ€æ‰‹åŠ¨è°ƒç”¨
6. **å•ä¾‹æ¨¡å¼**ï¼šå…¨å±€é…ç½®ç®¡ç†ï¼Œå†…å­˜æ•ˆç‡é«˜
7. **é€‚é…å™¨æ¨¡å¼**ï¼šç±»å‹è½¬æ¢ï¼Œæé«˜æ•°ç»„è®¿é—®æ€§èƒ½

è¿™äº›è®¾è®¡æ¨¡å¼çš„åˆç†è¿ç”¨ä½¿å¾—é“¶è¡Œåˆ†è¡Œæ¨¡æ‹Ÿå™¨å…·æœ‰è‰¯å¥½çš„å¯ç»´æŠ¤æ€§ã€å¯æ‰©å±•æ€§å’Œæ€§èƒ½è¡¨ç°ã€‚