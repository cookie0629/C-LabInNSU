# 任务目标

展现对 C++ 中多线程和并发性工作方法以及所用数据同步算法的了解，通过模拟本质上具有并发和并行特性的问题领域来体现。

# 学生技能

-   能够独立解决 C++ 程序中并行访问同步的典型问题，如死锁和数据竞争
-   熟悉 C++ 标准库中同步原语的用途
-   熟悉基于线程的以及 `future + promise` 对的多线程模型

# 任务完成要求

C++ 应用程序项目必须：

-   拥有基于 CMake 的构建系统
-   根据描述的技术要求展示程序行为

# 准备材料

需要开发一个控制台应用程序，用于模拟物流仓库中发生的过程。所有在区间内（从...到...）给定的量，都应在程序启动时或在运行过程中（如果这些数据是动态事件）由程序自动随机生成。可选地，为了调试目的，可以实现从文件加载这些量。

## 问题领域

仓库中的工作人员包括搬运工和经理。每个工作人员在程序中应由其自己的执行线程（`std::thread`）表示。每个搬运工在特定时间内完成仓库中所有可能的操作。搬运工每个操作的时间是个体化的，并在 1 到 5 秒之间（或在负载测试时为 1 到 5 毫秒）。此时，搬运工线程将休眠指定的时间。

仓库具有以下区域：

-   收货区 - 接收载有货物的卡车
-   存储区 - 存储带货物的托盘
-   包装区 - 包装订单
-   发货区 - 发送载有订单的卡车

### 货物

存在 3 种**类型**的货物：

-   轻型，一个托盘最多可放置 100 件，有 3 个品类
-   中型，一个托盘最多可放置 30 件，有 2 个品类
-   重型，一个托盘最多可放置 4 件，有 3 个品类

同一**种类**货物的不同**品类**可以混合放在一个托盘上，但需遵守数量限制。

### 卸货任务

所有搬运工同时收到关于新到达卡车及其泊位的信息。此事件包含到达卡车的组成。卡车内装有 10 到 100 个带货物的托盘。每个托盘可容纳 2 到 100 件货物。保证卡车装载正确。

### 收货区

载有货物的卡车到达收货区。每辆卡车占用收货区的一个泊位。收货区总共有 4 到 40 个卡车泊位。每个泊位都有自己的库存管理系统终端。

搬运工的任务是尽快卸下卡车并将货物转移到存储区（最小化新到达卡车在泊位中的停留时间）。为此，搬运工必须（4 个动作）：

1.  从卡车上取走托盘上的货物
    a. 同时在一辆卡车内的搬运工不能超过 3 名
2.  在库存管理系统的终端上输入托盘上货物的数量和品类，并获取货物在存储区的存储地址（或多个地址）
    a. 存储可能涉及装载整个托盘，也可能涉及将货物重新装载到其他未满的托盘上
3.  根据其地址将货物移至存储区
    a. 如果货物在 5 秒内未能成功移动，则搬运工：
        i.  如果他**不是**此任务上的最后一名搬运工，则放弃此任务
        ii. 如果他是此任务上的最后一名搬运工，则将任务放入任务队列
        iii. 转向其他任务
4.  在存储区的库存管理系统终端上标记货物已按指定地址放置

卡车完全卸货后，泊位被释放，卸货任务被视为完成。

### 存储区

存储区按货架、货架上的层、层上的托盘和托盘上的货物进行组织。每个货架包含最多 6 层。每层包含 10 个托盘位。仓库总共有 10 到 500 个货架。

一个托盘上只能放置一种**类型**的货物。

当托盘上的最后一件货物被取走后，层上的托盘位被释放。

从收货区托盘接收的货物必须放置在自己的托盘上（即只能放在空位上，不能重新分组）。

该区域有 1 到 10 个库存管理系统终端。

库存管理系统负责记录货物：

-   所有货物的地址
-   托盘的满载程度和组成
-   仓库中每种**类型**货物的数量
-   仓库中每个**品类**货物的数量
-   能够生成关于特定品类货物的报告，其中包括：
    -   仓库（存储区）中该品类货物的确切数量
    -   已接收（其条形码已在收货区终端扫描）的该品类货物的确切数量
    -   正在包装中（在包装区）的该品类货物的确切数量
    -   已发货的该品类货物的确切数量
    -   当前位于存储区且存在该品类货物的所有托盘的地址，以及这些托盘上该品类货物的确切数量

### 库存盘点任务

多个搬运工可以接收订单拣配任务。但每个任务只能由一名搬运工完成。

任务内容包括一组需要生成报告的货物品类。接手任务的搬运工必须在存储区的库存管理系统终端获取所有指定品类的报告。

### 订单

订单包含：

-   目的城市（总共 3 到 5 个城市）
-   每个品类货物的数量

### 拣配任务

多个搬运工可以接收订单拣配任务。每个任务包含可以同时从事该任务的最大搬运工数量。

### 包装区

包装区设有拣配工作台。每个拣配工作台有 1 到 3 个用于拆垛的托盘位和 2 个用于包装的托盘位。仓库总共有 2 到 20 个拣配工作台。在拣配工作台上，货物从存储托盘重新分组到发货托盘。

搬运工的任务是尽快完成订单的拣配和包装。为此，搬运工：

1.  接收订单拣配任务
2.  预订一个拣配工作台位（1 个动作）
    a. 如果在 5 秒内无法预订到工作台，则搬运工：
        i.  如果他**不是**此任务上的最后一名搬运工，则放弃此任务
        ii. 如果他是此任务上的最后一名搬运工，则将任务放入任务队列
        iii. 转向其他任务
3.  取走带货物的托盘，同时他取走的托盘数量不能超过拣配工作台的容量（最多 N 个动作）
    a. 在包装区的库存管理系统终端标记托盘已移至包装区（1 个动作）
    b. 在拣配工作台的库存管理系统终端标记特定数量的货物已送达用于特定订单的拣配（1 个动作）
4.  在拣配工作台上，根据订单要求将货物从存储托盘转移到发货托盘（移动每件货物算 1 个动作）
5.  如果发货托盘已满
    a. 在拣配工作台的库存管理系统终端标记他已放置在发货托盘上的特定数量的货物已准备好发货（1 个动作）
    b. 转到发货区装载托盘准备发货
6.  如果存储托盘已空（上面没有任何货物）
    a. 在包装区的库存管理系统终端标记托盘不再包含货物（1 个动作）
        i.  层上的托盘位被释放
7.  如果存储托盘不再包含用于拣配订单的货物
    a. 将托盘运回其原始地址（1 个动作）
    b. 在包装区的库存管理系统终端标记托盘已放回原位（1 个动作）
8.  如果订单仍需拣配
    a. 从步骤 3 开始重复动作
9.  如果订单不再需要拣配
    a. 如步骤 6 和 7 所述归还带货物的托盘
    b. 取消对拣配工作台的预订（1 个动作）

### 卡车到达

所有当前从事拣配任务的搬运工都会收到关于卡车到达和离开发货区的通知。此消息包含：

-   卡车到达/离开的泊位
-   如果卡车到达：
    -   卡车包含多少个托盘位（10 到 100 个）
    -   卡车前往哪个城市

卡车的到达和离开也会反映在发货区的占用状态板上，搬运工可以查看该状态板以确定将已拣配的托盘运往何处。

### 发货区

发货区设有用于发送订单的卡车泊位。每个泊位可以被卡车占用或空闲。每个泊位包含一个库存管理系统终端。一次只能有一名搬运工在卡车内进行装载（与收货时一样）。发货区总共有 4 到 40 个泊位。

搬运工带着订单托盘到达发货区时：

1.  如有必要：查看发货区的占用状态板
2.  如果有卡车要发往订单所属城市
    a. 排队等待装入卡车
        i.  如果卡车装满并离开 - 重复尝试发送托盘
    b. 执行装载
    c. 在卡车泊位的库存管理系统终端标记特定数量的货物已装货待发运
3.  如果没有卡车要发往订单所属城市
    a. 等待 1 到 5 秒（负载下为 1 到 5 毫秒），直到有卡车出现
    b. 重复尝试发送托盘
    c. 第 5 次尝试发送托盘失败后，搬运工：
        i.  将托盘退回拣配工作台
        ii. 准备接手其他任务
        iii. 该任务及其所有状态（拣配工作台的状态）被移回任务队列

当卡车完全装满（所有托盘位被占用）时，卡车出发。同时自动标记该卡车所载订单的货物已发货。

### 搬运工

如果没有任务需要执行，则认为搬运工在休息。其线程处于睡眠状态。仓库可以有 2 到 1000 名搬运工工作。

### 经理

经理的任务是设置仓库运作的任务。经理：

-   设置卸货任务
-   设置库存盘点任务
-   创建订单并设置拣配任务
-   通知用于发送订单的卡车到达

仓库可以有 1 到 20 名经理工作。

经理定期编写报告。认为他们为此使用带有库存管理系统客户端的个人电脑。

#### 订单状态报告

此报告应包含：

-   已完全发货的订单所需时间的分布（直方图）
    -   从订单创建到其包含的所有货物发送完毕的时间
-   处于不同阶段的订单数量
    -   等待中
    -   拣配中
    -   主动拣配中（有搬运工正在处理拣配）
    -   部分已发货
    -   完全已发货

#### 搬运工绩效报告

此报告包含：

-   每个搬运工按类型分类完成的任务数量
-   每个搬运工休息的时间量
-   当前休息的搬运工比例

# 参考资料和参考数据链接

关于多线程环境中出现问题的书籍，与编程语言无关：
[[https://greenteapress.com/semaphores/LittleBookOfSemaphores.pdf]{.underline}](https://greenteapress.com/semaphores/LittleBookOfSemaphores.pdf)

任务多路分发的替代方案可以是公共消息队列。

一些类的英文名称：

-   搬运工 - Loader
-   收货区 - ReceivingDock
-   存储区 - StorageZone
-   包装区 - PackingZone
-   发货区 - ShippingZone
-   仓库 - Warehouse

用于处理随机性的实用工具：

```cpp
// RandomGenerator.h
#pragma once
#include <random>

class RandomGenerator {
public:
    static std::mt19937 getGenerator();
    static int getRandom(int min, int max);
    static int getRandom(std::mt19937& gen, int min, int max);
    static std::uniform_int_distribution<> getDist(int min, int max);
};

// RandomGenerator.cpp
#include <utils/RandomGenerator.h>

static std::random_device& getDevice() {
    static std::random_device rd{};
    return rd;
}

std::mt19937 RandomGenerator::getGenerator() {
    return std::mt19937{getDevice()()};
}

int RandomGenerator::getRandom(int min, int max) {
    auto gen = getGenerator();
    return getDist(min, max)(gen);
}

int RandomGenerator::getRandom(std::mt19937& gen, int min, int max) {
    return getDist(min, max)(gen);
}

std::uniform_int_distribution<> RandomGenerator::getDist(int min, int max) {
    return std::uniform_int_distribution<>(min, max);
}
```